<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CACHE BUST: 2025-09-21-23:15 - FORCE TEMPLATE RELOAD -->
    <title>מערכת ניתוח הזמנות ברזל - IRONMAN</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Fix PDF.js worker error
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body>
    <!-- Main Header -->
    <header class="main-header">
        <div class="header-content">
            <h1>🦾 IRONMAN - מערכת ניתוח הזמנות ברזל</h1>
            <div class="header-info">
                <div class="info-item">
                    <span class="label">קובץ נוכחי:</span>
                    <span id="current-file" class="value">לא נבחר</span>
                </div>
                <div class="info-item">
                    <span class="label">מספר הזמנה:</span>
                    <span id="order-number" class="value">-</span>
                </div>
                <div class="info-item">
                    <span class="label">לקוח:</span>
                    <span id="customer-name" class="value">-</span>
                </div>
                <div class="info-item">
                    <span class="label">סטטוס:</span>
                    <span id="status" class="value status-ready">מוכן</span>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <button id="run-analysis" class="btn btn-primary">
                <span class="btn-icon">▶</span>
                הרץ ניתוח
            </button>
            <button id="refresh-data" class="btn btn-secondary">
                <span class="btn-icon">🔄</span>
                רענן נתונים
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Left Column: PDF Viewer -->
        <div class="column pdf-column">
            <div class="column-header">
                <h2>תצוגת מסמך PDF</h2>
                <div class="pdf-controls">
                    <button id="select-file-btn" class="btn btn-small btn-primary">
                        <span class="btn-icon">📁</span>
                        בחר קובץ
                    </button>
                    <button id="pdf-prev" class="btn-small">◀</button>
                    <span class="page-info">
                        עמוד <span id="page-num">1</span> מתוך <span id="page-count">1</span>
                    </span>
                    <button id="pdf-next" class="btn-small">▶</button>
                    <button id="pdf-zoom-in" class="btn-small">🔍+</button>
                    <button id="pdf-zoom-out" class="btn-small">🔍-</button>
                    <button id="area-select-btn" class="btn-small btn-toggle" title="בחירת אזור">📐</button>
                    <button id="clear-selections-btn" class="btn-small" title="נקה בחירות" style="display: none;">🗑️</button>
                </div>
                <div class="section-selection-controls" id="section-controls">
                    <div class="section-controls-row">
                        <button id="save-sections-btn" class="btn btn-primary btn-small" style="display: none;">
                            <span class="btn-icon">💾</span>
                            שמור הגדרות
                        </button>
                        <div class="section-buttons">
                            <button id="select-order-header" class="btn-section" data-section="order_header" title="בחר כותרת הזמנה">כותרת הזמנה</button>
                            <button id="select-table-header" class="btn-section" data-section="table_header" title="בחר כותרת טבלה">כותרת טבלה</button>
                            <button id="select-table-area" class="btn-section" data-section="table_area" title="בחר אזור טבלה">אזור טבלה</button>
                            <button id="select-shape-column" class="btn-section" data-section="shape_column" title="בחר עמודת צורות">עמודת צורות</button>
                        </div>
                    </div>
                    <div class="selection-status">
                        <span id="selection-status-text">בחר סוג אזור ולאחר מכן צייר על הPDF</span>
                    </div>
                </div>
            </div>
            <div class="pdf-viewer-container">
                <canvas id="pdf-canvas"></canvas>
                <canvas id="selection-canvas" class="selection-overlay"></canvas>
                <div id="pdf-placeholder" class="placeholder">
                    <p>📄 לא נטען מסמך PDF</p>
                    <p>לחץ על "הרץ ניתוח" כדי להתחיל</p>
                </div>
            </div>
        </div>

        <!-- Right Column: Extracted Data -->
        <div class="column data-column">
            <div class="column-header">
                <div class="header-top">
                    <h2 style="text-align: center;">
                        פרטי הזמנה <span id="title-page-display" style="background: blue; color: white; padding: 3px 6px; border-radius: 8px; font-size: 12px; margin-right: 20px;">עמוד -</span>
                    </h2>
                </div>
                <div class="data-tabs">
                    <button class="tab-btn" data-tab="header">כותרת</button>
                    <button class="tab-btn active" data-tab="table">טבלת הזמנות</button>
                    <button class="tab-btn" data-tab="shapes">צורות</button>
                    <button class="tab-btn" data-tab="raw">נתונים גולמיים</button>
                </div>
            </div>
            
            <!-- Header Tab Content -->
            <div id="header-tab" class="tab-content">
                <div class="data-section">
                    <div class="data-grid" id="header-data" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-width: 100%;">
                        <div class="data-row" style="padding: 4px 0;">
                            <span class="data-label" style="display: inline-block; width: 110px; font-size: 13px;">מספר הזמנה:</span>
                            <input class="data-editable" id="detail-order-number" type="text" placeholder="-" data-field="orderNumber" style="width: calc(100% - 115px); font-size: 13px; padding: 2px 4px;">
                        </div>
                        <div class="data-row" style="padding: 4px 0;">
                            <span class="data-label" style="display: inline-block; width: 110px; font-size: 13px;">לקוח/פרויקט:</span>
                            <input class="data-editable" id="detail-customer" type="text" placeholder="-" data-field="customer" style="width: calc(100% - 115px); font-size: 13px; padding: 2px 4px;">
                        </div>
                        <div class="data-row" style="padding: 4px 0;">
                            <span class="data-label" style="display: inline-block; width: 110px; font-size: 13px;">שם התוכנית:</span>
                            <input class="data-editable" id="detail-program-name" type="text" placeholder="-" data-field="programName" style="width: calc(100% - 115px); font-size: 13px; padding: 2px 4px;">
                        </div>
                        <div class="data-row" style="padding: 4px 0;">
                            <span class="data-label" style="display: inline-block; width: 110px; font-size: 13px;">איש קשר:</span>
                            <input class="data-editable" id="detail-contact" type="text" placeholder="-" data-field="contact" style="width: calc(100% - 115px); font-size: 13px; padding: 2px 4px;">
                        </div>
                        <div class="data-row" style="padding: 4px 0;">
                            <span class="data-label" style="display: inline-block; width: 110px; font-size: 13px;">טלפון:</span>
                            <input class="data-editable" id="detail-phone" type="text" placeholder="-" data-field="phone" style="width: calc(100% - 115px); font-size: 13px; padding: 2px 4px;">
                        </div>
                        <div class="data-row" style="padding: 4px 0;">
                            <span class="data-label" style="display: inline-block; width: 110px; font-size: 13px;">כתובת האתר:</span>
                            <input class="data-editable" id="detail-address" type="text" placeholder="-" data-field="address" style="width: calc(100% - 115px); font-size: 13px; padding: 2px 4px;">
                        </div>
                        <div class="data-row" style="padding: 4px 0;">
                            <span class="data-label" style="display: inline-block; width: 110px; font-size: 13px;">משקל כולל:</span>
                            <input class="data-editable" id="detail-weight" type="text" placeholder="-" data-field="weight" style="width: calc(100% - 115px); font-size: 13px; padding: 2px 4px;">
                        </div>
                        <div class="data-row" style="padding: 4px 0;">
                            <span class="data-label" style="display: inline-block; width: 110px; font-size: 13px;">תאריך הזמנה:</span>
                            <input class="data-editable" id="detail-order-date" type="text" placeholder="-" data-field="orderDate" style="width: calc(100% - 115px); font-size: 13px; padding: 2px 4px;">
                        </div>
                        <div class="data-row" style="padding: 4px 0;">
                            <span class="data-label" style="display: inline-block; width: 110px; font-size: 13px;">תאריך אספקה:</span>
                            <input class="data-editable" id="detail-delivery-date" type="text" placeholder="-" data-field="deliveryDate" style="width: calc(100% - 115px); font-size: 13px; padding: 2px 4px;">
                        </div>
                    </div>
                    <div class="auto-save-info">
                        <span id="save-status"></span>
                    </div>
                </div>

                <!-- Order Header Image Section - After Data -->
                <div class="header-image-section" style="margin-top: 15px;">
                    <h3 style="text-align: center; margin-bottom: 10px; color: #333; font-size: 16px;">כותרת הזמנה</h3>
                    <div class="header-image-container" style="text-align: center;">
                        <img id="order-header-image" src="/order_header_image/CO25S006375_order_title_page1_order_header.png"
                             alt="כותרת הזמנה"
                             style="width: 95%; max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" />
                    </div>
                </div>
            </div>

            <!-- Table Tab Content -->
            <div id="table-tab" class="tab-content active">
                <div class="data-section">
                    <div class="table-container">
                        <table id="items-table">
                            <thead>
                                <tr>
                                    <th width="4%"></th>
                                    <th width="6%">מס'</th>
                                    <th width="10%">קטלוג</th>
                                    <th width="30%">צורה</th>
                                    <th width="10%">קוטר (mm)</th>
                                    <th width="10%">יחידות</th>
                                    <th width="24%">הערות</th>
                                    <th width="6%">בדוק</th>
                                </tr>
                            </thead>
                            <tbody id="items-tbody">
                                <tr>
                                    <td colspan="8" class="no-data">אין נתונים להצגה</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="table-summary">
                        <div class="summary-item">
                            <span>סה"כ שורות:</span>
                            <span id="total-rows">0</span>
                        </div>
                        <div class="summary-item">
                            <span>סוג הזמנה:</span>
                            <span id="order-type">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shapes Tab Content -->
            <div id="shapes-tab" class="tab-content">
                <div class="data-section">
                    <div class="shapes-container" id="shapes-container">
                        <div class="shapes-table-wrapper">
                            <!-- Fixed Header -->
                            <table class="shapes-table shapes-header-table">
                                <thead>
                                    <tr>
                                        <th width="8%">עמוד/שורה</th>
                                        <th width="15%">קטלוג</th>
                                        <th width="38%">ציור צורה</th>
                                        <th width="39%">צורת קטלוג</th>
                                    </tr>
                                </thead>
                            </table>
                            <!-- Scrollable Body -->
                            <div class="shapes-body-container">
                                <table class="shapes-table shapes-body-table" id="shapes-table">
                                    <tbody id="shapes-tbody">
                                        <tr>
                                            <td colspan="4" class="no-shapes-placeholder">
                                                <p>🔍 לא נמצאו צורות</p>
                                                <p>הרץ ניתוח כדי לזהות צורות מהמסמך</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="table-summary">
                        <div class="summary-item">
                            <span>סה"כ צורות:</span>
                            <span id="total-shapes">0</span>
                        </div>
                        <div class="summary-item">
                            <span>עמוד נוכחי:</span>
                            <span id="current-shapes-page">-</span>
                        </div>
                        <div class="summary-item">
                            <span>סטטוס זיהוי:</span>
                            <span id="shapes-status">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Raw Data Tab Content -->
            <div id="raw-tab" class="tab-content">
                <div class="data-section">
                    <h3>נתונים גולמיים (JSON)</h3>
                    <pre id="raw-json" class="json-viewer">{}</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- File Selection Modal -->
    <div id="file-selection-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>בחירת קובץ מהתיקייה</h3>
                <button id="close-file-modal" class="btn-close">×</button>
            </div>
            <div class="modal-body">
                <div id="file-list-container">
                    <div class="loading">טוען קבצים...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-file-selection" class="btn btn-secondary">ביטול</button>
                <button id="confirm-file-selection" class="btn btn-primary" disabled>בחר קובץ</button>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <footer class="status-bar">
        <div class="status-left">
            <span id="last-update">עדכון אחרון: -</span>
        </div>
        <div class="status-center">
            <span id="processing-status"></span>
        </div>
        <div class="status-right">
            <span id="files-processed">קבצים שעובדו: 0</span>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/app.js') }}?v={{ range(1000000000, 9999999999) | random }}"></script>

    <!-- INLINE TEST SCRIPT -->
    <script>
    console.log('🔥 INLINE SCRIPT RUNNING - TEST FOR PAGE ELEMENTS');
    setTimeout(() => {
        console.log('🔥 INLINE: Manual DOM check after 3 seconds...');
        const tableEl = document.getElementById('current-page-display');
        const titleEl = document.getElementById('title-page-display');
        console.log('🔥 INLINE: Table element:', tableEl);
        console.log('🔥 INLINE: Title element:', titleEl);
        if (tableEl) {
            console.log('🔥 INLINE: ✅ Table element found! Setting to עמוד 1');
            tableEl.textContent = 'עמוד 1';
            tableEl.style.backgroundColor = 'blue';
            tableEl.style.color = 'white';
            tableEl.style.padding = '5px';
            tableEl.style.borderRadius = '10px';
        } else {
            console.log('🔥 INLINE: ❌ Table element NOT found');
        }
        if (titleEl) {
            console.log('🔥 INLINE: ✅ Title element found! Setting to עמוד 1');
            titleEl.textContent = 'עמוד 1';
        } else {
            console.log('🔥 INLINE: ❌ Title element NOT found');
        }
    }, 3000);
    </script>
</body>
</html>